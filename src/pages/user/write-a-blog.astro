---
import NoLayout from "../../layouts/NoLayout.astro";
import { X } from "lucide-react";

const user = await Astro.locals.currentUser();
const userEmail = user?.emailAddresses[0]?.emailAddress;

interface Author {
  name: string;
  slug: string;
  email: string;
  bio: string;
}

interface Tag {
  name: string;
  slug: string;
}

const query = {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
      {
        authors {
          name
          slug
          email
          bio
        }
        tags {
          name
          slug
        }
      }
    `,
  }),
};

const response = await fetch(import.meta.env.HYGRAPH_API, query);
const json = await response.json();
const author: Author | undefined = json?.data?.authors?.find(
  (a: Author) => a.email === userEmail
);
const userSlug = userEmail ? userEmail.split("@")[0]?.toLowerCase().replace(/[^a-z0-9]/g, "-") : "";
const existingTags: Tag[] = json?.data?.tags || [];
---
<NoLayout>
  <div class="flex items-center justify-center h-screen">
    {author ? (
      <div class="px-5 flex items-center justify-center w-full">
        <div class="relative z-10 bg-[#0e0e0e] border border-[#2c2c2c] rounded-[20px] p-5 max-w-3xl mx-auto w-full">
          <div class="flex justify-between items-center mb-5">
            <h3 class="text-xl font-semibold text-white">Edit Post</h3>
            <a 
              href="/"
              class="p-2 text-white bg-[#14100f] border border-[#3a2a1e] hover:text-orange-400 
              rounded-[8px] cursor-pointer" 
              aria-label="Go to home"
            >
              <X size={16} strokeWidth={1.5} />
            </a>
          </div>
          
          <form method="POST" action="/api/write-a-blog" class="space-y-5" id="blog-form">
            <input type="hidden" name="email" value={userEmail} />
            <input type="hidden" name="name" value={author.name} />
            
            <div>
              <label class="block mb-3 text-sm">Title</label>
              <input
                required
                name="title"
                type="text"
                class="w-full px-4 py-3 bg-[#1a1a1a] border border-[#2c2c2c] rounded-[16px] 
                focus:outline-none focus:border-[#ff6a00] text-white"
                placeholder="Astro JS in 2025"
              />
            </div>
            
            <div>
              <label for="tags" class="block text-sm font-medium text-gray-300 mb-2">Tags (comma-separated)</label>
              <input 
                type="text" 
                id="tags" 
                name="tags"
                class="w-full px-4 py-3 bg-[#1a1a1a] border border-[#2c2c2c] rounded-[16px] 
                focus:outline-none focus:border-[#ff6a00] text-white"
                placeholder="astro, javascript, web development"
              />
            </div>
            
            <div>
              <label class="block mb-3 text-sm">Content (Markdown)</label>
              <textarea
                required
                name="content"
                rows="10"
                class="w-full px-4 py-3 bg-[#1a1a1a] border border-[#2c2c2c] rounded-[16px] 
                focus:outline-none focus:border-[#ff6a00] text-white resize-none"
                placeholder="Your blog content here..."
              ></textarea>
            </div>
            
            <button
              type="submit"
              class="w-full px-6 py-3 rounded-[16px] bg-[#ff6a00] text-white 
              border border-[#ff6a00] hover:bg-[#EB5B00] cursor-pointer"
            >
              Submit Blog Post
            </button>
          </form>
        </div>
      </div>
    ) : (
      <div class="px-5 flex items-center justify-center w-full">
        <div class="relative z-10 bg-[#0e0e0e] border border-[#2c2c2c] rounded-[20px] p-5 max-w-3xl mx-auto w-full">
          <div class="flex justify-between items-center mb-5">
            <h3 class="text-xl font-semibold text-white">Register as Author</h3>
            <a 
              href="/"
              class="p-2 text-white bg-[#14100f] border border-[#3a2a1e] hover:text-orange-400 
              rounded-[8px] cursor-pointer" 
              aria-label="Go to home"
            >
              <X size={16} strokeWidth={1.5} />
            </a>
          </div>
          
          <form method="POST" action="/api/register-author" class="space-y-5">
            <input type="hidden" name="email" value={userEmail} />
            <input type="hidden" name="slug" value={userSlug} />

            <div>
              <label class="block mb-3 text-sm">Full Name</label>
              <input
                required
                name="name"
                type="text"
                class="w-full px-4 py-3 bg-[#1a1a1a] border border-[#2c2c2c] rounded-[16px] 
                focus:outline-none focus:border-[#ff6a00] text-white"
                placeholder="Jane Doe"
              />
            </div>

            <div>
              <label class="block mb-3 text-sm">Title</label>
              <input
                required
                name="title"
                type="text"
                class="w-full px-4 py-3 bg-[#1a1a1a] border border-[#2c2c2c] rounded-[16px] 
                focus:outline-none focus:border-[#ff6a00] text-white"
                placeholder="e.g. AI Researcher"
              />
            </div>

            <div>
              <label class="block mb-3 text-sm">Short Bio</label>
              <textarea
                required
                name="bio"
                rows="4"
                class="w-full px-4 py-3 bg-[#1a1a1a] border border-[#2c2c2c] rounded-[16px] 
                focus:outline-none focus:border-[#ff6a00] text-white resize-none"
                placeholder="Tell us a bit about yourself..."
              ></textarea>
            </div>

            <button
              type="submit"
              class="w-full px-6 py-3 rounded-[16px] bg-[#ff6a00] text-white 
              border border-[#ff6a00] hover:bg-[#EB5B00] cursor-pointer"
            >
              Register
            </button>
          </form>
        </div>
      </div>
    )}
  </div>
</NoLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tag pill functionality
    const tagInput = document.getElementById('tags') as HTMLInputElement;
    const tagPills = document.querySelectorAll('.tag-pill');
    
    if (tagInput && tagPills.length) {
      tagPills.forEach(pill => {
        pill.addEventListener('click', () => {
          const tagName = (pill as HTMLElement).dataset.tag;
          if (!tagName) return;
          
          const currentTags = tagInput.value
            ? tagInput.value.split(',').map(t => t.trim()).filter(t => t)
            : [];
          
          // Add tag if not already in the list
          if (!currentTags.includes(tagName)) {
            currentTags.push(tagName);
            tagInput.value = currentTags.join(', ');
          }
        });
      });
    }
  });
</script>